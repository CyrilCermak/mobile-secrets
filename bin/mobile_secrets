#!/usr/bin/env ruby
require_relative '../lib/src/secrets_handler'
require "dotgpg"

module MobileSecrets
  class Cli

    def header
    "Mobile Secrets HELP:
    ##############################################################################################################################
    ##  %# #%%%( ##%  ,%%%  (%%/   *%%%% ,%%%/       .%%(  (%%,  #%%%#.(%%#   #%%*.#%%% ,%%%%%.%%%%.   #%%%%.#%%%.*%% %%%%*#%%  ##
    ##  %  #%%%(  % *%%%#  /%%%(  *%%%%  %%%%,      %%%*    %,  (%%%#   #( .%%%(    %%  (%%%#  %%%%    %%%%.  .%.*%  %%%%* #%   ##
    ##     #%%%(    %%%%#  /%%%%  *%%%%  %%%%.     .%%%%%%#.    (%%%( ,%   %%%%(    ,#  (%%%# .%%%%   .%%%%. (*  ,(  %%%%* .#   ##
    ##     #%%%(    %%%%#  /%%%%  /%%%% *%%%*       *%%%%%%%%   (%%%((%%   %%%%(        (%%%#.#%#,    .%%%%.%%*      %%%%,      ##
    ##     #%%%(    #%%%#  /%%%%  /%%%%            .(  (%%%%%#  (%%%( ,%   %%%%(        (%%%# *%%%#   .%%%%. #*      %%%%,      ##
    ##     %%%%(     %%%#  /%%%.  /%%%%            ,%,    %%%/  (%%%(   (# (%%%(    *#  #%%%# .%%%%   .%%%%    #,    %%%%,      ##
    ##    %%%%%%(     /%%**%%(   ,%%%%%(           ,%%#. /%%*   #%%%(./%%#  *%%#  .##   #%%%# .%%%%#/ .%%%%  ,%%,    %%%%,      ##
    ##############################################################################################################################"
    end

    def options
      opt = ""
      opt << "--init-gpg PATH \tInitialize GPG in the directory.\n"
      opt << "--create-template \tCreates a template yml file to configure the MobileSecrets\n"
      opt << "--import GPG_PATH SECRETS_PATH \tAdds MobileSecrets to GPG secrets\n"
      opt << "--export \tCreates source file with obfuscated secrets\n\n"
      opt << "Examples:\n"
      opt << "--import \".\" \"./secrets.gpg\"\n"
      opt << "--init-gpg \".\""
      opt
    end

    def perform_action command, argv_1, argv_2
      case command
      when "--create-template"
        FileUtils.cp('../lib/resources/example.yml', "#{Dir.pwd}#{File::SEPARATOR}MobileSecrets.yml")
      when "--export"
        secrets_handler = MobileSecrets::SecretsHandler.new
        secrets_handler.export_secrets
      when "--init-gpg"
        print_options if argv_1 == nil
        
        Dotgpg::Cli.new.init(argv_1)
      when "--import"
        print_options if argv_1 == nil || argv_2 == nil

        dotgpg = Dotgpg::Dir.new(argv_1)
        file = IO.read argv_2
        dotgpg.encrypt "./secrets.gpg", file
      else
        print_options
      end
    end

    def print_options
      puts "#{header}\n\n#{options}" #Wrong action selected
    end

  end
end

cmd, argv_1, argv_2 = ARGV[0], ARGV[1], ARGV[2]
MobileSecrets::Cli.new.perform_action cmd, argv_1, argv_2
